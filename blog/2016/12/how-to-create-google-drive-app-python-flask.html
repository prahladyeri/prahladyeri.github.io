<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8" />
	<title>How to create a Google Drive App in Flask</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" property="og:description" content="This is the first in a series of articles for web programmers that explain in detail about using the Google Drive API in your web applications to access files/folders on behalf of the users of your application. In my last project, I had to develop a python flask app …">
	<link rel="canonical" content="https://prahladyeri.github.io/blog/2016/12/how-to-create-google-drive-app-python-flask.html" />
	<meta name="author" content="Prahlad Yeri">
	<link rel="stylesheet" href="/theme/css/app.css?v=1.10">
	<link rel="stylesheet" href="/theme/css/pygment.css">		
	<link rel="shortcut icon" type="image/x-icon" href="/uploads/py.png" />
	<link href="https://prahladyeri.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Full Atom Feed" />
	<link href="https://prahladyeri.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prahlad Yeri's Blog Full RSS Feed" />
	<link href="https://prahladyeri.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Categories Atom Feed" />




    <meta name="tags" content="Flask" />
    <meta name="tags" content="Google Drive" />
    <meta name="tags" content="Python" />
    <meta name="tags" content="How To" />

	
	<!-- fosstodon verify -->
	<a style='display:none'  rel="me" href="https://fosstodon.org/@prahladyeri">Fosstodon</a>
	<!-- mastodon verify -->
	<a style='display:none' rel="me" href="https://mastodon.social/@prahladyeri">Mastodon</a>
	
	<!-- pinterest verify -->
	<meta name="p:domain_verify" content="a57360faef2ee56807b63d62092a849a"/>
	
	<!-- twitter card meta data -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@prahladyeri" />
	<meta name="twitter:creator" content="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.github.io/blog/2016/12/how-to-create-google-drive-app-python-flask.html" />
		<meta name="twitter:title" content="How to create a Google Drive App in Flask" />
		<meta name="twitter:description" content="This is the first in a series of articles for web programmers that explain in detail about using the Google Drive API in your web applications to access files/folders on behalf of the users of your application. In my last project, I had to develop a python flask app …" />
			<meta name="twitter:image" content="https://prahladyeri.github.io/uploads/cover.jpg" />
			<meta name="image" property="og:image" content="https://prahladyeri.github.io/uploads/cover.jpg">

	
	
</head>

<body>
<div id='header'>
<div class='text-center' >
	<h1 class='blog-title'>Prahlad Yeri</h1>
	<h4  class='blog-tagline'>Freelance Programmer and Writer</h4>
</div>

<div id='navBlock' class='text-center' >
	<a class="nav-link" href="/">Home</a> | 
	<a class="nav-link" href="/blog">Blog</a> | 
	<a class="nav-link" href="/portfolio">Portfolio</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri/resume">Resume</a> | 
	<a class="nav-link" href="/hire-me">Hire Me</a>
	<br>
	Social:
	<a class="nav-link" href="https://twitter.com/prahladyeri">Twitter</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri">Github</a> | 
	<a class="nav-link" href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a> | 
	<a class="nav-link" href="https://prahladyeri.medium.com/">Medium</a> | 
	<a class="nav-link" href="https://www.quora.com/profile/Prahlad-Yeri">Quora</a>
	<br>
	Email: prahladyeri at yahoo dot com | 
	Feeds:
	<a class="nav-link" href="/feeds/all.rss.xml">RSS</a> | 
	<a class="nav-link" href="/feeds/all.atom.xml">ATOM</a>
</div>
</div>
<div id="main" class='row content '>
<div class='col w50 m-auto'>
<section id="content" class="body">
  <header>
	<h1 class='mt-4 mb-4 post-title'>How to create a Google Drive App in Flask</h1>
 
  </header>
  <footer class="post-info clearfix">
	<span class='float-left'>
    <time class="text-muted published" datetime="2016-12-29T04:21:00+05:30">2016-12-29</time>
    <div class="text-muted vcard author">
      By           <a class="url fn" href="https://prahladyeri.github.io/">Prahlad Yeri</a>
    </div>
	</span>
	<div class='float-right'>
    <div class="text-muted category text-right">
        Filed under <a href="https://prahladyeri.github.io/blog/category/python">Python</a>
    </div>
    <div class="text-muted tags">
		Tags
            <a href="https://prahladyeri.github.io/blog/tag/flask">Flask</a>
            <a href="https://prahladyeri.github.io/blog/tag/google-drive">Google Drive</a>
            <a href="https://prahladyeri.github.io/blog/tag/python">Python</a>
            <a href="https://prahladyeri.github.io/blog/tag/how-to">How To</a>
    </div>
	</div>
  </footer><!-- /.post-info -->
  
  <div class="entry-content">
    <p>This is the first in a series of articles for web programmers that explain in detail about using the Google Drive API in your web applications to access files/folders on behalf of the users of your application. In my last project, I had to develop a python flask app for my users that required to access the files stored in their google drive account.<!--more--></p>
<p>The major challenge for me was to authenticate to google and access the drive on the user’s behalf once they grant permission to my app. This method of authentication is called <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> and is very much needed for implementing the drive api.</p>
<p>However, a good documentation to implement this in a backend app, especially a python web-based app is very much lacking. The so called <a href="https://developers.google.com/drive/v3/web/quickstart/python">quickstart for drive api</a> shows some example code, but what I needed was a step-by-step tutorial of how to go about doing it. Since I couldn’t find any such tutorial online, I thought about writing one myself.</p>
<h3>I: Register a google app by visiting the <a href="https://console.developers.google.com/">Google API console</a>:</h3>
<p>The way the latest version (V3) of drive API works is only through OAuth. It means you cannot put a password or API key inside your code and access the drive files. You need to register your backend app and generate OAuth credentials for the app, so that it can access the drive on the user’s behalf once the user grants permission to the app. So the first step is going to the <a href="https://console.developers.google.com/">Google API console</a>, registering the app itself and generating OAuth credentials. The registration process is pretty straightforward, you just select “Create Project” from the dropdown and give a nice name for your project such as <code class="highlighter-rouge">Flask Drive Example App</code> in our case.</p>
<p><img alt="Register Google App" src="/uploads/old/google-apis/drive_api_steps.png"></p>
<h3 id="ii-configure-the-credentials-and-download-the-client_idjson-file">II: Configure the credentials and download the client_id.json file:</h3>
<p>This is the credential file that validates to Google who you are (as a developer) and also your app that acts on your behalf. Download and save it as <code class="highlighter-rouge">client_id.json</code> in the same directory as the flask app.</p>
<p><img alt="Configure Credentials" src="/uploads/old/google-apis/configuration_steps.png"></p>
<h3>III: Write your back-end app:</h3>
<p>The most important thing to know before building your app is to install these dependencies:</p>
<div class="highlight"><pre><span></span>pip install flask google-api-python-client
</pre></div>


<p>You can replace flask with django, pylons or any other framework you use, but this tutorial and code example is based on flask. The principle of accessing the drive api should still apply, so you should be able to make use of this code.</p>
<p>The first thing to do is create a flask object and handle the home page url. It could in fact be any other url in your app, but in this example, I’ve used the home page url (/) to do the OAuth authentication on behalf of the logged in user.</p>
<div class="highlight"><pre><span></span>app = flask.Flask(__name__)

@app.route(&#39;/&#39;)
def index():
    credentials = get_credentials()
    if credentials == False:
        return flask.redirect(flask.url_for(&#39;oauth2callback&#39;))
    elif credentials.access_token_expired:
        return flask.redirect(flask.url_for(&#39;oauth2callback&#39;))
    else:
        print(&#39;now calling fetch&#39;)
        all_files = fetch(&quot;&#39;root&#39; in parents and mimeType = &#39;application/vnd.google-apps.folder&#39;&quot;, sort=&#39;modifiedTime desc&#39;)
        s = &quot;&quot;
        for file in all_files:
            s += &quot;%s, %s&lt;br&gt;&quot; % (file[&#39;name&#39;],file[&#39;id&#39;])
        return s
</pre></div>


<p>We first check whether we have the drive access credentials for the user locally stored in a file. This is done by the <code class="highlighter-rouge">get_credentials()</code> function that checks the local access token file credentials.json (not to be confused with client_id.json we downloaded earlier which is for developer credentials). Again, we are assuming a single user scenario here. If your drive app needs to authenticate with multiple users, you’ll have to store separate credentials.json for each logged-in user in the database, and access that through a session or something.</p>
<p>Further, if credentials aren’t found locally or have expired, we direct them to <code class="highlighter-rouge">/oauth2callback</code>, so google will authenticate them and send us the token for accessing the drive, post which, we will put that token into the local file, credentials.json and redirect the user back to this index site. Finally, if the credentials are valid, we call the <code class="highlighter-rouge">fetch()</code> function that displays the list of all root folders in that user’s drive along with their IDs. Here is the code for <code class="highlighter-rouge">oauth2callback</code>:</p>
<div class="highlight"><pre><span></span>@app.route(&#39;/oauth2callback&#39;)
def oauth2callback():
    flow = client.flow_from_clientsecrets(&#39;client_id.json&#39;,
            scope=&#39;https://www.googleapis.com/auth/drive&#39;,
            redirect_uri=flask.url_for(&#39;oauth2callback&#39;, _external=True)) # access drive api using developer credentials
    flow.params[&#39;include_granted_scopes&#39;] = &#39;true&#39;
    if &#39;code&#39; not in flask.request.args:
        auth_uri = flow.step1_get_authorize_url()
        return flask.redirect(auth_uri)
    else:
        auth_code = flask.request.args.get(&#39;code&#39;)
        credentials = flow.step2_exchange(auth_code)
        open(&#39;credentials.json&#39;,&#39;w&#39;).write(credentials.to_json()) # write access token to credentials.json locally
        return flask.redirect(flask.url_for(&#39;index&#39;))
</pre></div>


<p>Once you have the credentials locally (in the form of <code class="highlighter-rouge">credentials.json</code>), you can just use it to access the drive API. Thus, the result of this whole exercise is that only on first page load is the user redirected to google site to authenticate themselves. Once the app has the access token (credentials.json), its no longer required, the result is displayed directly on the page from then on. If all goes well, you should be able to see a screen such as this when you test this example app for the first time:</p>
<p><img alt="Google OAuth Screen" src="/uploads/old/google-apis/oauth_screen.png"></p>
<p>I’ve also included the functions to download and upload files to the drive as they will be very useful:</p>
<div class="highlight"><pre><span></span>def download_file(file_id, output_file):
    credentials = get_credentials()
    http = credentials.authorize(httplib2.Http())
    service = discovery.build(&#39;drive&#39;, &#39;v3&#39;, http=http)
    #file_id = &#39;0BwwA4oUTeiV1UVNwOHItT0xfa2M&#39;
    request = service.files().export_media(fileId=file_id,mimeType=&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;)
    #request = service.files().get_media(fileId=file_id)

    fh = open(output_file,&#39;wb&#39;) #io.BytesIO()
    downloader = MediaIoBaseDownload(fh, request)
    done = False
    while done is False:
        status, done = downloader.next_chunk()
        #print (&quot;Download %d%%.&quot; % int(status.progress() * 100))
    fh.close()
    #return fh

def update_file(file_id, local_file):
    credentials = get_credentials()
    http = credentials.authorize(httplib2.Http())
    service = discovery.build(&#39;drive&#39;, &#39;v3&#39;, http=http)
    # First retrieve the file from the API.
    file = service.files().get(fileId=file_id).execute()
    # File&#39;s new content.
    media_body = MediaFileUpload(local_file, resumable=True)
    # Send the request to the API.
    updated_file = service.files().update(
        fileId=file_id,
        #body=file,
        #newRevision=True,
        media_body=media_body).execute()
</pre></div>


<hr>
<p>I’ll leave the more comprehensive use of these functions as an exercise to the reader who wants to develop a more fully featured app out of this. Click the below link to download the <code class="highlighter-rouge">flask_drive_example.py</code> script for this example implementation from the Github gist:</p>
<p><a class="btn btn-md btn-success" href="https://gist.githubusercontent.com/prahladyeri/0b92b9ca837a0f5474c732876220db78"> flask_drive_example.py</a></p>
  </div><!-- /.entry-content -->

	<!-- Start: Prahlad -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		console.log('DOMContentLoaded');
		var elems = document.querySelectorAll(".entry-content table");
		for(var i= 0;i<elems.length;i++) {
			if (!hasClass(elems[i], 'table')) addClass(elems[i], 'table');
			if (!hasClass(elems[i], 'table-bordered')) addClass(elems[i], 'table-bordered');
			if (!hasClass(elems[i], 'table-sm')) addClass(elems[i], 'table-sm');
		}
		document.querySelector(".entry-content img").parentElement.style.textAlign = "center";
	});
	</script>

	<!--start: adsense-->
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0428291735937735"
     crossorigin="anonymous"></script>
	<!-- prahladyeri.github.io -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="9729062115"
		 data-ad-format="auto"
		 data-full-width-responsive="true"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	
	
	
	<!-- End: Prahlad -->
</section>
</div>
<!-- <div id='push'></div> -->
</div>


<footer id ="footer" class="text-center">
<br>
Copyright (&copy;) 2014-2023 Prahlad Yeri. Build 1.10.<br>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</footer>

<script>
function hasClass(ele,cls) {
  return !!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

document.addEventListener('DOMContentLoaded', function() {
	//var hh = document.querySelector("#header").clientHeight;
	//var fh = document.querySelector("#footer").clientHeight;
	//document.querySelector("#main").style.height = "calc(100vh - " + (hh + fh) + "px);"
});
</script>

</body>
</html>