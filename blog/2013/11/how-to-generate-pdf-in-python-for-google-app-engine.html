<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8" />
	<title>How to Generate PDFs in Python for Google App Engine</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" property="og:description" content="One of my last projects based on google app engine and python involved storing form data in GAE datastore and generating PDF documents that the user can download. Whilst data storing was the easier part as google's big data API it is pretty well documented, the trickier aspect was to …">
	<link rel="canonical" content="https://prahladyeri.github.io/blog/2013/11/how-to-generate-pdf-in-python-for-google-app-engine.html" />
	<meta name="author" content="Prahlad Yeri">
	<link rel="stylesheet" href="/theme/css/app.css?v=1.11">
	<link rel="stylesheet" href="/theme/css/pygment.css">		
	<link rel="shortcut icon" type="image/x-icon" href="/uploads/py.png" />
	<link href="https://prahladyeri.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Full Atom Feed" />
	<link href="https://prahladyeri.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prahlad Yeri's Blog Full RSS Feed" />
	<link href="https://prahladyeri.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Categories Atom Feed" />




    <meta name="tags" content="Google App Engine" />
    <meta name="tags" content="Python" />
    <meta name="tags" content="How To" />

	
	<!-- fosstodon verify -->
	<a style='display:none'  rel="me" href="https://fosstodon.org/@prahladyeri">Fosstodon</a>
	<!-- mastodon verify -->
	<a style='display:none' rel="me" href="https://mastodon.social/@prahladyeri">Mastodon</a>
	
	<!-- pinterest verify -->
	<meta name="p:domain_verify" content="a57360faef2ee56807b63d62092a849a"/>
	
	<!-- twitter card meta data -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@prahladyeri" />
	<meta name="twitter:creator" content="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.github.io/blog/2013/11/how-to-generate-pdf-in-python-for-google-app-engine.html" />
		<meta name="twitter:title" content="How to Generate PDFs in Python for Google App Engine" />
		<meta name="twitter:description" content="One of my last projects based on google app engine and python involved storing form data in GAE datastore and generating PDF documents that the user can download. Whilst data storing was the easier part as google's big data API it is pretty well documented, the trickier aspect was to …" />
			<meta name="twitter:image" content="https://prahladyeri.github.io/uploads/cover.jpg" />
			<meta name="image" property="og:image" content="https://prahladyeri.github.io/uploads/cover.jpg">

	
	
</head>

<body>
<div id='header'>
<div class='text-center' >
	<h1 class='blog-title'>Prahlad Yeri</h1>
	<h4  class='blog-tagline'>Freelance Programmer and Writer</h4>
</div>

<div id='navBlock' class='text-center' >
	<a class="nav-link" href="/">Home</a> | 
	<a class="nav-link" href="/blog">Blog</a> | 
	<a class="nav-link" href="/portfolio">Portfolio</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri/resume">Resume</a> | 
	<a class="nav-link" href="/hire-me">Hire Me</a>
	<br>
	Social:
	<a class="nav-link" href="https://twitter.com/prahladyeri">Twitter</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri">Github</a> | 
	<a class="nav-link" href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a> | 
	<a class="nav-link" href="https://prahladyeri.medium.com/">Medium</a> | 
	<a class="nav-link" href="https://www.quora.com/profile/Prahlad-Yeri">Quora</a>
	<br>
	Email: prahladyeri at yahoo dot com | 
	Feeds:
	<a class="nav-link" href="/feeds/all.rss.xml">RSS</a> | 
	<a class="nav-link" href="/feeds/all.atom.xml">ATOM</a>
</div>
</div>
<div id="main" class='row content '>
<div class='col w50 m-auto'>
<section id="content" class="body">
  <header>
	<h1 class='mt-4 mb-4 post-title'>How to Generate PDFs in Python for Google App Engine</h1>
 
  </header>
  <footer class="post-info clearfix">
	<span class='float-left'>
    <time class="text-muted published" datetime="2013-11-26T19:07:00+05:30">2013-11-26</time>
    <div class="text-muted vcard author">
      By           <a class="url fn" href="https://prahladyeri.github.io/">Prahlad Yeri</a>
    </div>
	</span>
	<div class='float-right'>
    <div class="text-muted category text-right">
        Filed under <a href="https://prahladyeri.github.io/blog/category/python">Python</a>
    </div>
    <div class="text-muted tags">
		Tags
            <a href="https://prahladyeri.github.io/blog/tag/google-app-engine">Google App Engine</a>
            <a href="https://prahladyeri.github.io/blog/tag/python">Python</a>
            <a href="https://prahladyeri.github.io/blog/tag/how-to">How To</a>
    </div>
	</div>
  </footer><!-- /.post-info -->
  
  <div class="entry-content">
    <p>One of my last projects based on google app engine and python involved storing form data in GAE datastore and generating PDF documents that the user can download. Whilst data storing was the easier part as google's big data API it is pretty <a href="https://developers.google.com/appengine/docs/python/datastore/">well documented</a>, the trickier aspect was to convert it to PDF using python.<!--more--></p>
<p><a href="/uploads/old/pdf.png"><img alt="pdf" class="alignnone wp-image-164" height="108" src="/uploads/old/pdf-300x300.png" width="108"></a></p>
<p>This was especially difficult in the face of GAE not providing an easy mechanism for disk writing that most PDF generation libraries require. To share my endeavors, I'm writing this post about how to generate pdfs in python for Google app engine.</p>
<p>The solution I came across was, as far as I know, the only possible way of generating PDFs in python! There are about three PDF generation utilities in python, each differing in terms of their area of usage:</p>
<ul>
<li><a href="http://www.reportlab.com"><strong>Reportlab PDF library</strong></a>: This is the ideal library, if you want to create a pdf from scratch. It provides objects like canvas, pdfmetrics and ttfonts that help you with stuff like adding lines, shapes, images and paragraphs. This is pretty much comparable to the comprehensive iText java library or its C# port, iTextSharp. Their <a href="http://www.reportlab.com/software/documentation/">documentation</a> is also good.</li>
<li><a href="http://www.xhtml2pdf.com/"><strong>xhtml2pdf</strong></a>: If you want to simply convert an existing html document to pdf, the xhtml2pdf library comes in very handy.</li>
<li><a href="https://pypi.python.org/pypi/pyPdf"><strong>pyPDF</strong></a>: If all you want to do is merge two PDFs page by page quickly, this library is the way to go.</li>
</ul>
<p>I figured out after researching the above three libraries that a combination of xhtml2pdf and pyPDF is what I needed. Since I already had the html document template ready, I just put placeholders for my form data like __name__ , __occupation__, etc so that I can fill these before converting to PDF.</p>
<p>Now, I could fill these values from my python program, but the real challenge was storing the resulting PDF to disk, which was not allowed by google app engine! Turns out, we don't need to actually store anything to disk. By sending the CreatePDF() output to a <a href="http://docs.python.org/library/stringio.html">StringIO</a> object, which is stored in memory instead of the filesystem, I could bypass the need to actually store anything to disk!!</p>
<div class="highlight"><pre><span></span>f=open(&#39;template.htm&#39;,&#39;r&#39;)
sourceHtml = unicode(f.read(), errors=&#39;ignore&#39;)
f.close()
sourceHtml = template.render(tvals)
sourceHtml = sourceHtml.replace(&#39;__name__&#39;,sname)
sourceHtml = sourceHtml.replace(&#39;__address__&#39;,saddress)
sourceHtml = sourceHtml.replace(&#39;__occupation__&#39;,will.occupation)
packet = StringIO.StringIO() #write to memory
pisa.CreatePDF(sourceHtml,dest=packet)
</pre></div>


<p>Now, it would have been simple to just self.response.write(packet) to send this pdf download to the user, but in my case, I had to merge this generated pdf with another template-pdf which contained information like symbols, images and page-numbers that for some reason, could not be placed into the html document. So, I had to create a PdfFileReader object (coutesy of PyPDF library!), and then merge each page of my generated document with this template document. Then where do I write this merged output? Any guesses? - another StringIO object!! And then finally, write this StringIO object to self.response, so the user can download it.</p>
<div class="highlight"><pre><span></span>packet.seek(0)
new =PdfFileReader(packet) #generated pdf
template = PdfFileReader(file(&quot;template.pdf&quot;, &quot;rb&quot;)) #template pdf
output=PdfFileWriter() #writer for the merged pdf
for i in range(new.getNumPages()):
    page=template.getPage(i)
    page.mergePage(new.getPage(i))
    output.addPage(page)

outputStream = StringIO.StringIO()
output.write(outputStream) #write merged output to the StringIO object

self.response.headers[&#39;Content-Type&#39;] = &#39;application/pdf&#39;
fname = (will.name if mirror==&#39;n&#39; else will.partner)
self.response.headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=&#39; + str(fname).replace(&#39; &#39;,&#39;_&#39;) + &#39;.pdf&#39;
self.response.write(outputStream.getvalue())
</pre></div>


<p>Remember to add and include the below libraries before you do this:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">xhtml2pdf.pisa</span> <span class="kn">as</span> <span class="nn">pisa</span>
<span class="kn">from</span> <span class="nn">pyPdf</span> <span class="kn">import</span> <span class="n">PdfFileWriter</span><span class="p">,</span><span class="n">PdfFileReader</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfgen</span> <span class="kn">import</span> <span class="n">canvas</span>
<span class="kn">from</span> <span class="nn">reportlab.lib.pagesizes</span> <span class="kn">import</span> <span class="n">A4</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfbase</span> <span class="kn">import</span> <span class="n">pdfmetrics</span><span class="p">,</span><span class="n">ttfonts</span>
</pre></div>


<p><em>References:</em></p>
<ul>
<li><a href="https://developers.google.com/appengine/docs/python/datastore/">https://developers.google.com/appengine/docs/python/datastore/</a></li>
<li><a href="http://www.reportlab.com/software/documentation/">http://www.reportlab.com/software/documentation/</a></li>
<li><a href="http://www.xhtml2pdf.com/">http://www.xhtml2pdf.com/</a></li>
<li><a href="https://pypi.python.org/pypi/pyPdf">https://pypi.python.org/pypi/pyPdf</a></li>
<li><a href="http://stackoverflow.com/q/4899885/849365">http://stackoverflow.com/q/4899885/849365</a></li>
<li><a href="http://stackoverflow.com/q/13522638/849365">http://stackoverflow.com/q/13522638/849365</a></li>
<li><a href="http://docs.python.org/library/stringio.html">http://docs.python.org/library/stringio.html</a></li>
</ul>
  </div><!-- /.entry-content -->

	<!-- Start: Prahlad -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		console.log('DOMContentLoaded');
		var elems = document.querySelectorAll(".entry-content table");
		for(var i= 0;i<elems.length;i++) {
			if (!hasClass(elems[i], 'table')) addClass(elems[i], 'table');
			if (!hasClass(elems[i], 'table-bordered')) addClass(elems[i], 'table-bordered');
			if (!hasClass(elems[i], 'table-sm')) addClass(elems[i], 'table-sm');
		}
		document.querySelector(".entry-content img").parentElement.style.textAlign = "center";
	});
	</script>

	<!--start: adsense-->
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0428291735937735"
     crossorigin="anonymous"></script>
	<!-- prahladyeri.github.io -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="9729062115"
		 data-ad-format="auto"
		 data-full-width-responsive="true"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	
	
	
	<!-- End: Prahlad -->
</section>
</div>
<!-- <div id='push'></div> -->
</div>


<footer id ="footer" class="text-center">
<br>
Copyright (&copy;) 2014-2023 Prahlad Yeri. Build 1.11.<br>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</footer>

<script>
function hasClass(ele,cls) {
  return !!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

document.addEventListener('DOMContentLoaded', function() {
	//var hh = document.querySelector("#header").clientHeight;
	//var fh = document.querySelector("#footer").clientHeight;
	//document.querySelector("#main").style.height = "calc(100vh - " + (hh + fh) + "px);"
});
</script>

</body>
</html>