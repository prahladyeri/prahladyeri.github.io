<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8" />
	<title>How to perform Microsoft OneDrive OAuth sign-in and authorization in a python web app</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" property="og:description" content="The methods and examples given in this article are based on flask framework but they should apply to django or something similar too with a little tweak. Few weeks ago, I had landed myself on a project of similar nature and though I found several helpful articles and blog posts …">
	<link rel="canonical" content="https://prahladyeri.github.io/blog/2020/11/how-to-perform-microsoft-onedrive-oauth-sign-in-and-authorization-in-a-python-web-app.html" />
	<meta name="author" content="Prahlad Yeri">
	<link rel="stylesheet" href="/theme/css/app.css?v=1.3">
	<link rel="stylesheet" href="/theme/css/pygment.css">		
	<link rel="shortcut icon" type="image/x-icon" href="/uploads/py.png" />
	<link href="https://prahladyeri.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Full Atom Feed" />
	<link href="https://prahladyeri.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prahlad Yeri's Blog Full RSS Feed" />
	<link href="https://prahladyeri.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Categories Atom Feed" />




    <meta name="tags" content="OneDrive" />
    <meta name="tags" content="Microsoft" />
    <meta name="tags" content="Azure" />
    <meta name="tags" content="Cloud" />

	
	<!-- fosstodon verify -->
	<a rel="me" href="https://fosstodon.org/@prahladyeri">Mastodon</a>
	
	<!-- pinterest verify -->
	<meta name="p:domain_verify" content="a57360faef2ee56807b63d62092a849a"/>
	
	<!-- twitter card meta data -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@prahladyeri" />
	<meta name="twitter:creator" content="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.github.io/blog/2020/11/how-to-perform-microsoft-onedrive-oauth-sign-in-and-authorization-in-a-python-web-app.html" />
		<meta name="twitter:title" content="How to perform Microsoft OneDrive OAuth sign-in and authorization in a python web app" />
		<meta name="twitter:description" content="The methods and examples given in this article are based on flask framework but they should apply to django or something similar too with a little tweak. Few weeks ago, I had landed myself on a project of similar nature and though I found several helpful articles and blog posts …" />
			<meta name="twitter:image" content="https://prahladyeri.github.io/uploads/code-python.jpg" />
			<meta name="image" property="og:image" content="https://prahladyeri.github.io/uploads/code-python.jpg">

	
	
</head>

<body>
<div id='header'>
<div class='text-center' >
	<h1 style='color:darkseagreen'>Prahlad Yeri</h1>
	<h4  style='color:grey;'>Freelance Programmer and Writer</h4>
</div>

<div id='navBlock' class='text-center' >
	<a class="nav-link" href="/">Home</a> | 
	<a class="nav-link" href="/blog">Blog</a> | 
	<a class="nav-link" href="/portfolio">Portfolio</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri/resume">Resume</a> | 
	<a class="nav-link" href="/hire-me">Hire Me</a>
	<br>
	Social:
	<a class="nav-link" href="https://twitter.com/prahladyeri">Twitter</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri">Github</a> | 
	<a class="nav-link" href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a> | 
	<a class="nav-link" href="https://prahladyeri.medium.com/">Medium</a> | 
	<a class="nav-link" href="https://www.quora.com/profile/Prahlad-Yeri">Quora</a>
	<br>
	Email: prahladyeri at yahoo dot com | 
	Feeds:
	<a class="nav-link" href="/feeds/all.rss.xml">RSS</a> | 
	<a class="nav-link" href="/feeds/all.atom.xml">ATOM</a>
</div>
</div>
<div id="main" class='row content '>
<div class='col w50 m-auto'>
<section id="content" class="body">
  <header>
	<h1 style='color: darkolivegreen;' class='mt-4 mb-4'>How to perform Microsoft OneDrive OAuth sign-in and authorization in a python web app</h1>
 
  </header>
  <footer class="post-info clearfix">
	<span class='float-left'>
    <time class="text-muted published" datetime="2020-11-14T09:50:00+05:30">Sat 14 November 2020</time>
    <div class="text-muted vcard author">
      By           <a class="url fn" href="https://prahladyeri.github.io/">Prahlad Yeri</a>
    </div>
	</span>
	<div class='float-right'>
    <div class="text-muted category text-right">
        Filed under <a href="https://prahladyeri.github.io/blog/category/python">Python</a>
    </div>
    <div class="text-muted tags">
		Tags
            <a href="https://prahladyeri.github.io/blog/tag/onedrive">OneDrive</a>
            <a href="https://prahladyeri.github.io/blog/tag/microsoft">Microsoft</a>
            <a href="https://prahladyeri.github.io/blog/tag/azure">Azure</a>
            <a href="https://prahladyeri.github.io/blog/tag/cloud">Cloud</a>
    </div>
	</div>
  </footer><!-- /.post-info -->
  
  <div class="entry-content">
    <p>The methods and examples given in this article are based on flask framework but they should apply to django or something similar too with a little tweak. Few weeks ago, I had landed myself on a project of similar nature and though I found several helpful articles and blog posts (such as <a href="https://dev.to/jsnmtr/automating-files-upload-to-microsoft-onedrive-unexpected-challenges-and-a-success-story-2ini">this one</a>), none of them explained this process in a simple but comprehensive manner, so I'm writing one myself.</p>
<p><img alt="python code" src="/uploads/code-python.jpg"></p>
<p>The first and foremost step is to visit the <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade">Azure developer portal</a> and register your app there. Just make sure that you select "All Microsoft account users" for supported account types and not just personal Microsoft accounts. This is needed in case you want your web app to perform OneDrive file transfers on behalf of the signed in user.</p>
<p>Make note of the <code>client_id</code> and <code>client_secret</code> values and store them somewhere as you're going to need them while writing your app code.</p>
<p>Its also important to add the following permissions by clicking the "API permissions" link, and then add a scope for them by visiting the "Expose an API" link on the developer console screen:</p>
<table>
<thead>
<tr>
<th><strong>API/Permissions</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Files.ReadWrite.All</td>
<td>Delegated</td>
<td>Have full access to all files user can access</td>
</tr>
<tr>
<td>offline_access</td>
<td>Delegated</td>
<td>Maintain access to data you have given it access to</td>
</tr>
<tr>
<td>User.Read</td>
<td>Delegated</td>
<td>Sign in and read user profile</td>
</tr>
</tbody>
</table>
<p>Also note that if you couldn't set the supported account types to "All Microsoft account users" in the initial setup for some reason, you can later change it by updating the following XML setting after visiting the "Manifest" link on the app console:</p>
<div class="highlight"><pre><span></span>&quot;signInAudience&quot;: &quot;AzureADandPersonalMicrosoftAccount&quot;,
</pre></div>


<p>Finally, its also important to configure redirect URIs by visiting the "Authentication" screen. This is the URL endpoint where our signed-in user will be redirected to and our app receives the "code" request argument which is needed to complete the OAuth process. In my case, I configured two redirect URIs, one for testing and one for production respectively:</p>
<div class="highlight"><pre><span></span>- http://localhost:5000/post_onedrive
- https://example-app.com/post_onedrive
</pre></div>


<p>Once the registered app is configured thus, we focus on our python app. Its important to provide the two URL endpoints here:</p>
<ol>
<li>First, where our signed in user visits (by clicking a link/button that says "Authorize OneDrive" or "Link OneDrive"), and thus starts the OAuth process:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/link_onedrive&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">link_onedrive</span><span class="p">():</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">opendb</span><span class="p">()</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from settings&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id={client_id}&amp;scope={scope}&amp;response_type=code&amp;redirect_uri={redirect_uri}&quot;</span>
    <span class="c1">#scopes = &quot;wl.basic onedrive.readwrite wl.offline_access&quot;</span>
    <span class="n">scopes</span> <span class="o">=</span> <span class="s2">&quot;Files.ReadWrite.All offline_access&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;od_client_id&#39;</span><span class="p">],</span> <span class="n">scope</span><span class="o">=</span><span class="n">scopes</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="o">=</span><span class="n">OD_REDIRECT_URI</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;url: &quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>


<p>In this case, I've already stored the app credentials like client_id, etc. in a <code>sqlite</code> table called settings from which I'm fetching them using a database connection. After that, its only a matter of calling the oauth URL with those specific parameters.</p>
<ol>
<li>Second, where the OneDrive's redirection is handled (/post_onedrive in above example):</li>
</ol>
<div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/post_onedrive&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">post_onedrive</span><span class="p">():</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">opendb</span><span class="p">()</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from settings&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;One Drive: HERE HERE!&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;now calling finish url&quot;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://login.microsoftonline.com/common/oauth2/v2.0/token?client_id={client_id}&amp;redirect_uri={redirect_uri}&amp;client_secret={client_secret}&amp;code={code}&amp;grant_type=authorization_code&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;od_client_id&#39;</span><span class="p">],</span> <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;od_client_secret&#39;</span><span class="p">],</span> <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">OD_REDIRECT_URI</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span><span class="s1">&#39;authorization_code&#39;</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">],</span> <span class="n">redirect_uri</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;redirect_uri&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">client_secret</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;client_secret&#39;</span><span class="p">],</span> <span class="n">code</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;json response:&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;saving tokens&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;delete from user_creds where user_id=? and auth_type=&#39;onedrive&#39;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],))</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into user_creds(user_id, auth_type, access_token, refresh_token) values (?,?,?,?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s1">&#39;onedrive&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">]))</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update users set od_auth=&#39;y&#39; where id=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],))</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;od_auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Your One Drive account was linked successfully!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">))</span>
</pre></div>


<p>Once OneDrive redirects me to the <code>/post_onedrive</code> endpoint, I just have to complete the process using the code (<code>request.args['code']</code>) parameter, so that I can get <code>access_token</code> and <code>refresh_token</code> values. Once I get these values, I can store them as credentials against that user's account (<code>user_creds</code> sqlite table in this case). Once that is done, I (or my app) can access that user's drive any time. The <code>access_token</code> credential has a expiration limit of one hour but after that we can get a new <code>access_token</code> using the <code>refresh_token</code> parameter.</p>
<p>Here is a part of <code>cron.py</code> background script which keeps accessing each user's drive by using the <code>access_token</code> and <code>refresh_token</code> received thus. In this case, the function is used to create a new folder on the user's drive at a given path:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_folder_in_od</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span> <span class="c1"># create folder in onedrive</span>
    <span class="n">write_log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;creating folder in onedrive: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dst_path</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">))</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span><span class="s1">&#39;bearer &#39;</span> <span class="o">+</span> <span class="n">creds</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="n">drive_url</span> <span class="o">=</span> <span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root:</span><span class="si">%s</span><span class="s1">:/children&#39;</span> <span class="o">%</span> <span class="n">dst_path</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">folder_name</span><span class="p">,</span> <span class="s2">&quot;folder&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="p">}}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">drive_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">write_log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;success!&quot;</span><span class="p">)</span>
</pre></div>


<p>Here, settings and creds correspond to sqlite rows in settings and user_creds table respectively, which store the app settings (client_id and client_secret) and user settings (access_token and refresh_token) respectively.</p>
<p>The <code>drive_url</code> variable consists of two parts: The Microsoft Graph site URL which provides the Drive API (graph.microsoft.com/v1.0) and the particular API endpoint for creating a new folder on the drive (/me/drive/root:<path>:/children). Similarly, there are OneDrive API endpoints for doing other things, they are thoroughly documented, <a href="https://docs.microsoft.com/en-us/onedrive/developer/rest-api/resources/driveitem?view=odsp-graph-online">here</a> you can find various API endpoints for uploading, downloading, etc.</p>
<p>In the next couple of days, I'll try to put up a demo repo for this whole thing on Github. Until then, Happy Coding!</p>
  </div><!-- /.entry-content -->

	<!-- Start: Prahlad -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		console.log('DOMContentLoaded');
		var elems = document.querySelectorAll(".entry-content table");
		for(var i= 0;i<elems.length;i++) {
			if (!hasClass(elems[i], 'table')) addClass(elems[i], 'table');
			if (!hasClass(elems[i], 'table-bordered')) addClass(elems[i], 'table-bordered');
			if (!hasClass(elems[i], 'table-sm')) addClass(elems[i], 'table-sm');
		}
		document.querySelector(".entry-content img").parentElement.style.textAlign = "center";
	});
	</script>

	<!--start: adsense-->
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0428291735937735"
     crossorigin="anonymous"></script>
	<!-- prahladyeri.github.io -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="9729062115"
		 data-ad-format="auto"
		 data-full-width-responsive="true"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	
	
	
	<!-- End: Prahlad -->
</section>
</div>
</div>


<footer id ="footer" class="text-center">
Copyright (&copy;) 2014-2022 Prahlad Yeri.<br>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</footer>

<script>
function hasClass(ele,cls) {
  return !!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}
</script>

</body>
</html>