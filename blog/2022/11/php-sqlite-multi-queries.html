<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8" />
	<title>[PHP/Codeigniter] Getting multi-queries right with SQLITE</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" property="og:description" content="My earlier article dealt with multi-query issues of MySQL, this one is dedicated to SQLITE. Multi-queries are often discouraged to begin with but there are times when you find yourself using them. One typical use case is populating the database initially when it's empty. You do this by running an …">
	<link rel="canonical" content="https://prahladyeri.github.io/blog/2022/11/php-sqlite-multi-queries.html" />
	<meta name="author" content="Prahlad Yeri">
	<!-- Google Fonts -->
	<!--link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300&display=swap" rel="stylesheet"-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
	<link rel="stylesheet" href="/theme/css/app.css">
	<link rel="stylesheet" href="/theme/css/pygment.css">		
	<link rel="shortcut icon" type="image/x-icon" href="/uploads/py.png" />
	<link href="https://prahladyeri.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Full Atom Feed" />
	<link href="https://prahladyeri.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prahlad Yeri's Blog Full RSS Feed" />
	<link href="https://prahladyeri.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Categories Atom Feed" />




    <meta name="tags" content="PHP" />
    <meta name="tags" content="SQLITE" />
    <meta name="tags" content="SQL" />

	
	
	
	<!-- twitter card meta data -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@prahladyeri" />
	<meta name="twitter:creator" content="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.github.io/blog/2022/11/php-sqlite-multi-queries.html" />
		<meta name="twitter:title" content="[PHP/Codeigniter] Getting multi-queries right with SQLITE" />
		<meta name="twitter:description" content="My earlier article dealt with multi-query issues of MySQL, this one is dedicated to SQLITE. Multi-queries are often discouraged to begin with but there are times when you find yourself using them. One typical use case is populating the database initially when it's empty. You do this by running an …" />
			<meta name="twitter:image" content="https://prahladyeri.github.io/uploads/code-php.jpeg" />
			<meta name="image" property="og:image" content="https://prahladyeri.github.io/uploads/code-php.jpeg">

	
	
<!--pinterest claim-->
<meta name="p:domain_verify" content="eb43d46309e2766ef1b627cea2d19326"/>
</head>

<body id="index" class="home">
<!-- section bootstrap-menu -->
<div class='container'>
<div class='row header'>
	<div class='col-md-12 text-center' style='margin: 10px 0 0 0'>
		<h2>Prahlad Yeri</h2>
		<h6 class='text-muted'>Freelance Programmer and Writer</h6>
	</div>
	<div class='col-md-12 text-center' >
		<ul class="nav nav-fill text-center site-links col-md-8 ml-auto mr-auto">
		<li class="nav-item"><a class="nav-link btn btn-primary" href="/">Home</a></li>
		<li class="nav-item"><a class="nav-link btn btn-success" href="/blog">Blog</a></li>
		<li class="nav-item"><a class="nav-link btn btn-danger" href="/portfolio">Portfolio</a></li>
		<li class="nav-item"><a class="nav-link btn btn-secondary" href="https://github.com/prahladyeri/resume">Resume</a></li>
		<li class="nav-item"><a class="nav-link btn btn-warning" href="/hire-me">Hire Me</a></li>
		<li class='nav-item dropdown'>
			<a class="nav-link dropdown-toggle btn btn-dark" id='btnSocial' href="javascript:" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Social</a>
			<div class="dropdown-menu" aria-labelledby="btnSocial">
				<a class="dropdown-item" href="https://twitter.com/prahladyeri">Twitter</a>
				<a class="dropdown-item" href="https://github.com/prahladyeri">Github</a>
				<a class="dropdown-item" href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a>
				<a class="dropdown-item" href="https://prahladyeri.medium.com/">Medium</a>
				<a class="dropdown-item" href="https://www.quora.com/profile/Prahlad-Yeri">Quora</a>
				<a class="dropdown-item" href="https://www.instagram.com/prahladyeri14/">Instagram</a>
				<a class="dropdown-item" href="mailto:prahladyeri@yahoo.com">Email</a>
			</div>
		</li>
		<li class='btn-group'>
			<a class="nav-link dropdown-toggle btn btn-info" role='button' id='btnFeeds' href="javascript:" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Feeds</a>
			<div class="dropdown-menu" aria-labelledby="btnFeeds">
				<a class="dropdown-item" href="/feeds/all.rss.xml">RSS</a>
				<a class="dropdown-item" href="/feeds/all.atom.xml">ATOM</a>
				<!-- <a class="dropdown-item" href="https://feedburner.google.com/fb/a/mailverify?uri=prahladyeri&amp;loc=en_US">Feedburner</a> -->
			</div>
		</li>
		</ul>
	</div>
</div>

<div class='row'>
	<div class='ml-auto col-md-8 mr-auto'>
	</div>
</div>
</div>

		<div id="main" class='mt-2 container content '>
			<div class='row'>
				<div class='offset-md-2 col-md-8'>
<section id="content" class="body">
  <header>
    <h1 class="entry-title">
      <span class="text-secondary" href="https://prahladyeri.github.io/blog/2022/11/php-sqlite-multi-queries.html" rel="bookmark" 
      title="Permalink to [PHP/Codeigniter] Getting multi-queries right with SQLITE">[PHP/Codeigniter] Getting multi-queries right with SQLITE</span></h1>
 
  </header>
  <footer class="post-info clearfix">
	<span class='float-sm-none float-md-left'>
    <time class="text-muted published" datetime="2022-11-14T16:00:00+05:30">Mon 14 November 2022</time>
    <div class="text-muted vcard author">
      By           <a class="url fn" href="https://prahladyeri.github.io/">Prahlad Yeri</a>
    </div>
	</span>
	<div class='float-sm-none float-md-right'>
    <div class="text-muted category text-right">
        Filed under <a href="https://prahladyeri.github.io/blog/category/php">PHP</a>
    </div>
    <div class="text-muted tags">
		Tags
            <a href="https://prahladyeri.github.io/blog/tag/php">PHP</a>
            <a href="https://prahladyeri.github.io/blog/tag/sqlite">SQLITE</a>
            <a href="https://prahladyeri.github.io/blog/tag/sql">SQL</a>
    </div>
	</div>
  </footer><!-- /.post-info -->
  <br>
  <div class="entry-content">
    <p>My <a href="/blog/2022/10/php-mysql-multi-queries.html">earlier article</a> dealt with multi-query issues of MySQL, this one is dedicated to SQLITE. Multi-queries are often discouraged to begin with but there are times when you find yourself using them. One typical use case is populating the database initially when it's empty. You do this by running an SQL script which may include multiple queries for creating tables, views, stored procedures, etc. and a few insert queries to populate default records (such as an admin user).</p>
<div class="highlight"><pre><span></span><span class="x">$sql = file_get_contents(APPPATH . &#39;core\\install.sql&#39;);</span>
<span class="x">$this-&gt;db-&gt;query($sql);</span>
</pre></div>


<p>The above is what you typically do when it comes to Codeigniter framework but when I tried this (using <code>sqlite3</code> database driver), I was shocked to know that the multi-query didn't work at at all. Only the first SQL statement (among a soup of them separated by semi-colon) was working.</p>
<p>So I googled it and came to know that it was <a href="https://bugs.php.net/bug.php?id=28264">an old bug</a>. Apparently, they have now fixed it in later versions of PHP but only if you use <code>sqlite_exec()</code> instead of <code>sqlite_query()</code> function to run the query. Now, obviously our Codeigniter's database abstraction layer was running the latter because I was still facing this same bug as of PHP 7.</p>
<p>So I tried to scavenge and find out what exact function Codeigniter was running for sqlite3 driver by studying the file <code>system\database\drivers\sqlite3\sqlite3_driver.php</code>. And here I found out that the driver was running the <code>sqlite_exec()</code> or <code>sqlite_query()</code> based on the very weirdest logic! Apparently, this driver tries to find out the first <strong>word</strong> in your whole soup of SQL and only if it starts with one of these (DDL) statements, it ran the <code>sqlite_exec()</code>, otherwise it ran the <code>sqlite_query()</code>:</p>
<div class="highlight"><pre><span></span><span class="x">public function is_write_type($sql)</span>
<span class="x">{</span>
<span class="x">    return (bool) preg_match(&#39;/^\s*&quot;?(SET|INSERT|UPDATE|DELETE|REPLACE|CREATE|DROP|TRUNCATE|LOAD|COPY|ALTER|RENAME|GRANT|REVOKE|LOCK|UNLOCK|REINDEX|MERGE)\s/i&#39;, $sql);</span>
<span class="x">}</span>
</pre></div>


<p>Now, my <code>install.sql</code> actually started with a bunch of comments explaining what the whole thing was about, I had to remove this comment block and ensure that it started with a <code>CREATE</code> statement, only then the multi-query worked with Codeigniter.</p>
  </div><!-- /.entry-content -->

	<!-- Start: Prahlad -->
	<script>
	$(document).ready(function(){
		$(".entry-content table").addClass("table table-bordered table-sm");
		$(".entry-content img").parent().css({'text-align': 'center'});
	});
	</script>

	<!--start: adsense-->
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0428291735937735"
     crossorigin="anonymous"></script>
	<!-- prahladyeri.github.io -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="9729062115"
		 data-ad-format="auto"
		 data-full-width-responsive="true"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	
    <div class="comments">
		<hr>
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
	  
      <script type="text/javascript">
        var disqus_shortname = 'prahladyeri-blog';
        var disqus_identifier = 'blog/2022/11/php-sqlite-multi-queries.html';
        var disqus_url = 'https://prahladyeri.github.io/blog/2022/11/php-sqlite-multi-queries.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//prahladyeri-blog.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
	
	
	<!-- End: Prahlad -->
</section>
				</div>
				<div class='col-md-2 amz-block-right '> <!--align-self-center-->
					<div style='margin-top: 50px;'>

<!-- AMAZON AFFILIATE ADS -->
<!--
<a href="https://www.amazon.in/Automate-Boring-Stuff-Python-2nd/dp/1593279922/ref=as_li_ss_il?crid=JA705IOUH74O&keywords=automate+the+boring+stuff+with+python&qid=1583912586&sprefix=automate+the+,aps,460&sr=8-1&linkCode=li2&tag=prahladyeri-21&linkId=5f899269cc1aea74977c02963a9a6caf&language=en_IN" target="_blank"><img border="0" src="//ws-in.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=1593279922&Format=_SL160_&ID=AsinImage&MarketPlace=IN&ServiceVersion=20070822&WS=1&tag=prahladyeri-21&language=en_IN" ></a><img src="https://ir-in.amazon-adsystem.com/e/ir?t=prahladyeri-21&language=en_IN&l=li2&o=31&a=1593279922" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
<a href="https://www.amazon.in/PYTHON-PROGRAMMING-BEGINNERS-GUIDE-LEARN-ebook/dp/B01GSODGZC/ref=as_li_ss_il?crid=33LIIMVDMW1U3&keywords=python+programming&qid=1583912662&sprefix=python,aps,527&sr=8-4&linkCode=li2&tag=prahladyeri-21&linkId=6b3a8b38eda1d6c51546a1a0c321cfea&language=en_IN" target="_blank"><img border="0" src="//ws-in.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=B01GSODGZC&Format=_SL160_&ID=AsinImage&MarketPlace=IN&ServiceVersion=20070822&WS=1&tag=prahladyeri-21&language=en_IN" ></a><img src="https://ir-in.amazon-adsystem.com/e/ir?t=prahladyeri-21&language=en_IN&l=li2&o=31&a=B01GSODGZC" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
-->

					</div>
				</div>
			</div>
		</div>

<div class='container-fluid'>
<div class='row'>
		<footer id ="footer" class="col-md-12 text-center bg-dark text-white pt-1 pb-1 pl-1 pr-1">
		Copyright (&copy;) 2014-2022 Prahlad Yeri. This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
		</footer>
</div>
</div>		

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!-- <script src="/theme/js/popper.min.js"></script> -->
<!-- <script src="/theme/js/bootstrap.min.js"></script> -->
</body>
</html>