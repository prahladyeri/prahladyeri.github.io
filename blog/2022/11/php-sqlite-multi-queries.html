<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8" />
	<title>[PHP/Codeigniter] Getting multi-queries right with SQLITE</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" property="og:description" content="My earlier article dealt with multi-query issues of MySQL, this one is dedicated to SQLITE. Multi-queries are often discouraged to begin with but there are times when you find yourself using them. One typical use case is populating the database initially when it's empty. You do this by running an …">
	<link rel="canonical" content="https://prahladyeri.github.io/blog/2022/11/php-sqlite-multi-queries.html" />
	<meta name="author" content="Prahlad Yeri">
	<link rel="stylesheet" href="/theme/css/app.css?v=1.4">
	<link rel="stylesheet" href="/theme/css/pygment.css">		
	<link rel="shortcut icon" type="image/x-icon" href="/uploads/py.png" />
	<link href="https://prahladyeri.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Full Atom Feed" />
	<link href="https://prahladyeri.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prahlad Yeri's Blog Full RSS Feed" />
	<link href="https://prahladyeri.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Categories Atom Feed" />




    <meta name="tags" content="PHP" />
    <meta name="tags" content="SQLITE" />
    <meta name="tags" content="SQL" />

	
	<!-- fosstodon verify -->
	<a style='display:none'  rel="me" href="https://fosstodon.org/@prahladyeri">Fosstodon</a>
	<!-- mastodon verify -->
	<a style='display:none' rel="me" href="https://mastodon.social/@prahladyeri">Mastodon</a>
	
	<!-- pinterest verify -->
	<meta name="p:domain_verify" content="a57360faef2ee56807b63d62092a849a"/>
	
	<!-- twitter card meta data -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@prahladyeri" />
	<meta name="twitter:creator" content="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.github.io/blog/2022/11/php-sqlite-multi-queries.html" />
		<meta name="twitter:title" content="[PHP/Codeigniter] Getting multi-queries right with SQLITE" />
		<meta name="twitter:description" content="My earlier article dealt with multi-query issues of MySQL, this one is dedicated to SQLITE. Multi-queries are often discouraged to begin with but there are times when you find yourself using them. One typical use case is populating the database initially when it's empty. You do this by running an …" />
			<meta name="twitter:image" content="https://prahladyeri.github.io/uploads/code-php.jpeg" />
			<meta name="image" property="og:image" content="https://prahladyeri.github.io/uploads/code-php.jpeg">

	
	
</head>

<body>
<div id='header'>
<div class='text-center' >
	<h1 class='blog-title'>Prahlad Yeri</h1>
	<h4  class='blog-tagline'>Freelance Programmer and Writer</h4>
</div>

<div id='navBlock' class='text-center' >
	<a class="nav-link" href="/">Home</a> | 
	<a class="nav-link" href="/blog">Blog</a> | 
	<a class="nav-link" href="/portfolio">Portfolio</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri/resume">Resume</a> | 
	<a class="nav-link" href="/hire-me">Hire Me</a>
	<br>
	Social:
	<a class="nav-link" href="https://twitter.com/prahladyeri">Twitter</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri">Github</a> | 
	<a class="nav-link" href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a> | 
	<a class="nav-link" href="https://prahladyeri.medium.com/">Medium</a> | 
	<a class="nav-link" href="https://www.quora.com/profile/Prahlad-Yeri">Quora</a>
	<br>
	Email: prahladyeri at yahoo dot com | 
	Feeds:
	<a class="nav-link" href="/feeds/all.rss.xml">RSS</a> | 
	<a class="nav-link" href="/feeds/all.atom.xml">ATOM</a>
</div>
</div>
<div id="main" class='row content '>
<div class='col w50 m-auto'>
<section id="content" class="body">
  <header>
	<h1 style='color: darkolivegreen;' class='mt-4 mb-4'>[PHP/Codeigniter] Getting multi-queries right with SQLITE</h1>
 
  </header>
  <footer class="post-info clearfix">
	<span class='float-left'>
    <time class="text-muted published" datetime="2022-11-14T16:00:00+05:30">Mon 14 November 2022</time>
    <div class="text-muted vcard author">
      By           <a class="url fn" href="https://prahladyeri.github.io/">Prahlad Yeri</a>
    </div>
	</span>
	<div class='float-right'>
    <div class="text-muted category text-right">
        Filed under <a href="https://prahladyeri.github.io/blog/category/php">PHP</a>
    </div>
    <div class="text-muted tags">
		Tags
            <a href="https://prahladyeri.github.io/blog/tag/php">PHP</a>
            <a href="https://prahladyeri.github.io/blog/tag/sqlite">SQLITE</a>
            <a href="https://prahladyeri.github.io/blog/tag/sql">SQL</a>
    </div>
	</div>
  </footer><!-- /.post-info -->
  
  <div class="entry-content">
    <p>My <a href="/blog/2022/10/php-mysql-multi-queries.html">earlier article</a> dealt with multi-query issues of MySQL, this one is dedicated to SQLITE. Multi-queries are often discouraged to begin with but there are times when you find yourself using them. One typical use case is populating the database initially when it's empty. You do this by running an SQL script which may include multiple queries for creating tables, views, stored procedures, etc. and a few insert queries to populate default records (such as an admin user).</p>
<div class="highlight"><pre><span></span><span class="x">$sql = file_get_contents(APPPATH . &#39;core\\install.sql&#39;);</span>
<span class="x">$this-&gt;db-&gt;query($sql);</span>
</pre></div>


<p>The above is what you typically do when it comes to Codeigniter framework but when I tried this (using <code>sqlite3</code> database driver), I was shocked to know that the multi-query didn't work at at all. Only the first SQL statement (among a soup of them separated by semi-colon) was working.</p>
<p>So I googled it and came to know that it was <a href="https://bugs.php.net/bug.php?id=28264">an old bug</a>. Apparently, they have now fixed it in later versions of PHP but only if you use <code>sqlite_exec()</code> instead of <code>sqlite_query()</code> function to run the query. Now, obviously our Codeigniter's database abstraction layer was running the latter because I was still facing this same bug as of PHP 7.</p>
<p>So I tried to scavenge and find out what exact function Codeigniter was running for sqlite3 driver by studying the file <code>system\database\drivers\sqlite3\sqlite3_driver.php</code>. And here I found out that the driver was running the <code>sqlite_exec()</code> or <code>sqlite_query()</code> based on the very weirdest logic! Apparently, this driver tries to find out the first <strong>word</strong> in your whole soup of SQL and only if it starts with one of these (DDL) statements, it ran the <code>sqlite_exec()</code>, otherwise it ran the <code>sqlite_query()</code>:</p>
<div class="highlight"><pre><span></span><span class="x">public function is_write_type($sql)</span>
<span class="x">{</span>
<span class="x">    return (bool) preg_match(&#39;/^\s*&quot;?(SET|INSERT|UPDATE|DELETE|REPLACE|CREATE|DROP|TRUNCATE|LOAD|COPY|ALTER|RENAME|GRANT|REVOKE|LOCK|UNLOCK|REINDEX|MERGE)\s/i&#39;, $sql);</span>
<span class="x">}</span>
</pre></div>


<p>Now, my <code>install.sql</code> actually started with a bunch of comments explaining what the whole thing was about, I had to remove this comment block and ensure that it started with a <code>CREATE</code> statement, only then the multi-query worked with Codeigniter.</p>
  </div><!-- /.entry-content -->

	<!-- Start: Prahlad -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		console.log('DOMContentLoaded');
		var elems = document.querySelectorAll(".entry-content table");
		for(var i= 0;i<elems.length;i++) {
			if (!hasClass(elems[i], 'table')) addClass(elems[i], 'table');
			if (!hasClass(elems[i], 'table-bordered')) addClass(elems[i], 'table-bordered');
			if (!hasClass(elems[i], 'table-sm')) addClass(elems[i], 'table-sm');
		}
		document.querySelector(".entry-content img").parentElement.style.textAlign = "center";
	});
	</script>

	<!--start: adsense-->
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0428291735937735"
     crossorigin="anonymous"></script>
	<!-- prahladyeri.github.io -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="9729062115"
		 data-ad-format="auto"
		 data-full-width-responsive="true"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	
	
	
	<!-- End: Prahlad -->
</section>
</div>
</div>


<footer id ="footer" class="text-center">
Copyright (&copy;) 2014-2023 Prahlad Yeri.<br>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</footer>

<script>
function hasClass(ele,cls) {
  return !!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}
</script>

</body>
</html>