<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8" />
	<title>[PHP/Codeigniter] Playing with multi-queries in MySQL</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" property="og:description" content="Multi-queries are often discouraged with mysqli functions but there are times when you must use them. One obvious use case is initializing the database. One of the first things your app must do is determine if the database tables exist or not, and then run an initializing SQL script if â€¦">
	<link rel="canonical" content="https://prahladyeri.github.io/blog/2022/10/php-mysql-multi-queries.html" />
	<meta name="author" content="Prahlad Yeri">
	<link rel="stylesheet" href="/theme/css/app.css?v=1.14">
	<link rel="stylesheet" href="/theme/css/pygment.css">
	<link rel="shortcut icon" type="image/x-icon" href="/uploads/py.webp" />
	<link href="https://prahladyeri.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Full Atom Feed" />
	<link href="https://prahladyeri.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prahlad Yeri's Blog Full RSS Feed" />
	<link href="https://prahladyeri.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri's Blog Categories Atom Feed" />




    <meta name="tags" content="PHP" />
    <meta name="tags" content="MySQL" />
    <meta name="tags" content="SQL" />

	
	<!-- fosstodon verify -->
	<a style='display:none'  rel="me" href="https://fosstodon.org/@prahladyeri">Fosstodon</a>
	<!-- mastodon verify -->
	<a style='display:none' rel="me" href="https://mastodon.social/@prahladyeri">Mastodon</a>
	
	<!-- pinterest verify -->
	<meta name="p:domain_verify" content="a57360faef2ee56807b63d62092a849a"/>
	
	<!-- twitter card meta data -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@prahladyeri" />
	<meta name="twitter:creator" content="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.github.io/blog/2022/10/php-mysql-multi-queries.html" />
		<meta name="twitter:title" content="[PHP/Codeigniter] Playing with multi-queries in MySQL" />
		<meta name="twitter:description" content="Multi-queries are often discouraged with mysqli functions but there are times when you must use them. One obvious use case is initializing the database. One of the first things your app must do is determine if the database tables exist or not, and then run an initializing SQL script if â€¦" />
			<meta name="twitter:image" content="https://prahladyeri.github.io/uploads/code-php.jpeg" />
			<meta name="image" property="og:image" content="https://prahladyeri.github.io/uploads/code-php.jpeg">

	
	
</head>

<body>
<div id='header'>
<div class='text-center' >
	<h1 class='blog-title'>Prahlad Yeri</h1>
	<h4  class='blog-tagline'>Freelance Programmer and Writer</h4>
</div>

<div id='navBlock' class='text-center' >
	<a class="nav-link" href="/">Home</a> | 
	<a class="nav-link" href="/blog">Blog</a> | 
	<a class="nav-link" href="/portfolio">Portfolio</a> | 
	<a class="nav-link" href="https://github.com/prahladyeri/resume">Resume</a> | 
	<a class="nav-link" href="/hire-me">Hire Me</a>
	<br>
	Social:
	<a class="nav-link" href="https://github.com/prahladyeri">Github</a> | 
	<a class="nav-link" href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a> | 
	<a class="nav-link" href="https://twitter.com/prahladyeri">Twitter</a> | 
	<a class="nav-link" href="https://prahladyeri.medium.com/">Medium</a>
	<br>ðŸ“© prahladyeri at yahoo dot com | 
	<a class="nav-link" href="/feeds/all.rss.xml">RSS</a> | 
	<a class="nav-link" href="/feeds/all.atom.xml">ATOM</a>
</div>
</div>
<div id="main" class='row content '>
<div class='col w50 m-auto'>
<section id="content" class="body">
  <header>
	<h1 class='mt-4 mb-4 post-title'>[PHP/Codeigniter] Playing with multi-queries in MySQL</h1>
 
  </header>
  <footer class="post-info clearfix">
	<span class='float-left'>
    <time class="text-muted published" datetime="2022-10-12T14:00:00+05:30">2022-10-12</time>
    <div class="text-muted vcard author">
      By           <a class="url fn" href="https://prahladyeri.github.io/">Prahlad Yeri</a>
    </div>
	</span>
	<div class='float-right'>
    <div class="text-muted category text-right">
        Filed under <a href="https://prahladyeri.github.io/blog/category/php">PHP</a>
    </div>
    <div class="text-muted tags">
		Tags
            <a href="https://prahladyeri.github.io/blog/tag/php">PHP</a>
            <a href="https://prahladyeri.github.io/blog/tag/mysql">MySQL</a>
            <a href="https://prahladyeri.github.io/blog/tag/sql">SQL</a>
    </div>
	</div>
  </footer><!-- /.post-info -->
  
  <div class="entry-content">
    <p>Multi-queries are often discouraged with <code>mysqli</code> functions but there are times when you must use them. One obvious use case is initializing the database. One of the first things your app must do is determine if the database tables exist or not, and then run an initializing SQL script if they don't. This script may include multiple queries for creating tables, views, stored procedures, etc. and a few insert queries to populate default records (such as an admin user).</p>
<p>Running multiple queries with <code>mysqli</code> isn't an exact science though! The <a href="https://www.php.net/manual/en/mysqli.multi-query.php"><code>mysqli_multi_query</code></a> function is technically the way to do it but there are some quirks you must be aware of when using it.</p>
<p>A major challenge here is error handling. The above function sends the individual queries (separated by semi-colons) to server one by one and stops executing the moment it faces an error in one of them. As stated in <a href="https://stackoverflow.com/a/7867175/849365">this stackoverflow answer</a>, there is no official way to fetch errors in each and every one of your statements.</p>
<p>What you must do, in fact, is keep calling <code>mysqli_next_result()</code> again and again until each query result (or error) is fetched. This is how a proper implementation looks like (the code would probably be much shorter if it was implemented using some other technology like python or ADO.NET!):</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="p">[]);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">method</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nx">APPPATH</span> <span class="o">.</span> <span class="s1">&#39;../init.sql&#39;</span><span class="p">);</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_multi_query</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">conn_id</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nx">db_error</span><span class="p">();</span> <span class="c1">//handle error</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">mysqli_more_results</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">conn_id</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_next_result</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">conn_id</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nx">db_error</span><span class="p">();</span> <span class="c1">//handle error</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">&#39;The system is successfully installed!&lt;br&gt;&lt;a href=&quot;/auth/login&quot;&gt;Click here&lt;/a&gt; to login!&#39;</span><span class="p">;</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;installed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Another quirk to be aware of with <code>mysqli_multi_query</code> is that you must ALWAYS fetch the results by calling <code>mysqli_next_result</code> subsequently until <code>mysqli_more_results()</code> returns true. Not doing so may introduce some inadvertent bugs in your code when you later try to fetch records through <code>mysqli_query</code>.</p>
<p>Happy coding and let me know through comments below how your implementation goes!</p>
  </div><!-- /.entry-content -->

	<!-- Start: Prahlad -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		console.log('DOMContentLoaded');
		var elems = document.querySelectorAll(".entry-content table");
		for(var i= 0;i<elems.length;i++) {
			if (!hasClass(elems[i], 'table')) addClass(elems[i], 'table');
			if (!hasClass(elems[i], 'table-bordered')) addClass(elems[i], 'table-bordered');
			if (!hasClass(elems[i], 'table-sm')) addClass(elems[i], 'table-sm');
		}
		document.querySelector(".entry-content img").parentElement.style.textAlign = "center";
	});
	</script>

	<!--start: adsense-->
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0428291735937735"
     crossorigin="anonymous"></script>
	<!-- prahladyeri.github.io -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="9729062115"
		 data-ad-format="auto"
		 data-full-width-responsive="true"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	
	
	
	<!-- End: Prahlad -->
</section>
</div>
<!-- <div id='push'></div> -->
</div>


<footer id ="footer" class="text-center">
<br>
Copyright (&copy;) 2014-2023 Prahlad Yeri. Build 1.14.<br>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</footer>

<script>
function hasClass(ele,cls) {
  return !!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

document.addEventListener('DOMContentLoaded', function() {
	//var hh = document.querySelector("#header").clientHeight;
	//var fh = document.querySelector("#footer").clientHeight;
	//document.querySelector("#main").style.height = "calc(100vh - " + (hh + fh) + "px);"
});
</script>

</body>
</html>